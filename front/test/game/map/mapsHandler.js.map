{"version":3,"file":"mapsHandler.js","sourceRoot":"","sources":["mapsHandler.ts"],"names":[],"mappings":"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","sourcesContent":["/* --------------------------------------------------------------------------------------*\\\n    \n    Maps.js controls the saving and retrieving of maps\n\n\\* --------------------------------------------------------------------------------------*/\n\napp = require(\"../settings/app.js\");\napp.settings = require(\"../settings/game.js\");\napp.request = require(\"../tools/request.js\");\napp.game = require(\"../controller/game.js\");\n\nValidator = require(\"../tools/validator.js\");\nMap = require(\"./mapController.js\");\n\nmodule.exports = function () {\n\n\tvar error, maps, keys, change, index, type = \"map\", category;\n\tvar validate = new Validator(\"maps\"), categories = [\"two\"], which = \"open\";\n\n\tvar types = {\n\n\t\tmap:{\n\t\t\turl:\"maps/type\",\n\t\t\titems:[],\n\t\t\telements:{\n\t            section: \"mapSelectScreen\",\n\t            div:\"selectMapScreen\",\n\t            li:\"mapSelectionIndex\",\n\t            type:\"map\"\n\t        }\n\t\t},\n\n\t\tgame:{\n\t\t\turl:\"games/open\",\n\t\t\titems:[],\n\t\t\telements: {\n\t            section: \"gameSelectScreen\",\n\t            div:\"selectGameScreen\",\n\t            li:\"mapSelectionIndex\",\n\t            type:\"game\",\n\t            index:\"Index\",\n\t            attribute:\"class\",\n\t            url:\"games/open\",\n\t            properties: app.settings.categories\n\t        }\n        }\n\t};\n\n\tvar byCategory = function (cat, callback) {\n\n\t\tif (which === \"saved\") {\n\n\t\t\tcat = app.user.id();\n\t\t}\n\n\t\tif (cat && cat !== category) {\n\n\t\t\tmaps = [], keys = [], category = cat;\n\n\t        app.request.get(category, types[type].url, function (response) {\n\n\t            if (response && !response.error) {\n\n\t            \t// console.log(response);\n\n\t            \tmaps = types[type].items = response;\n\t            \tkeys = Object.keys(response);\n\n\t            \tif (callback) {\n\n\t            \t\tcallback (maps);\n\t            \t}\n\t            }\n\t           \tchange = true;\n\t        });\n\t    }\n       \treturn this;\n    };\n\n    var format = function (map) {\n\n\t    return map ? (map.map ? map : new Map(\n\t   \t\tmap.id,\n    \t\tmap.name,\n    \t\tmap.players,\n    \t\tmap.dimensions,\n    \t\tmap.terrain,\n    \t\tmap.buildings,\n    \t\tmap.units\n    \t)) : {};\n    };\n\n    var byIndex = function (ind) {\n\n\t\tindex = ind;\n\n\t\tvar m = sub(format(maps[ind]));\n\n\t\treturn m.map ? m.map : m;\n\t};\n\n\tvar indexById = function (array, id) {\n\n\t\treturn array.findIndex(function (element) {\n\n\t\t\treturn element.id == id;\n\t\t});\n\t};\n\n\tvar byId = function (array, id) {\n\n\t\treturn array[indexById(array, id)];\n\t};\n    \n    var sub = function (map) {\n\n    \treturn maps.length ? map : [];\n    };\n\n    var edit = function (array, element, callback) {\n\n        if (category === element.category || element.saved) {\n\n        \tvar index = indexById(array, element.id);\n\n        \tcallback(array, element, index);\n\n            change = true;\n\n            return element;\n        }\n        return false;\n    };\n\n    var elementExists = function (id, element, parent) {\n\n        var exists = document.getElementById(id);\n\n        exists ? parent.replaceChild(element, exists) : parent.appendChild(element);\n    };\n\n    var buildingElements = {\n\n    \tsection:\"buildingsDisplay\", \n    \tdiv:\"numberOfBuildings\"\n    };\n\n    byCategory(categories[0]);\n\n\treturn {\n\n\t\tbyIndex:byIndex,\n\n\t\ttype: function (t) {\n\n\t\t\tif (type !== t) {\n\n\t\t\t\ttype = t;\n\t\t\t\tcategory = false;\n\t\t\t\tbyCategory(\"two\");\n\t\t\t}\n\n\t\t\treturn this;\n\t\t},\n\n\t\trunning: function () {\n\n\t\t\tthis.setGameUrl((which = \"running\")); \n\n\t\t\treturn this;\n\t\t},\n\n\t\topen: function () {\n\n\t\t\tthis.setGameUrl((which = \"open\")); \n\n\t\t\treturn this;\n\t\t},\n\n\t\tsetGameUrl: function (type) {\n\n\t\t\ttypes.game.url = \"games/\"+type;\n\t\t},\n\n\t\tsaved: function () {\n\n\t\t\tthis.setGameUrl((which = \"saved\"));\n\n\t\t\treturn this;\n\t\t},\n\n\t\tempty: function () { \n\n\t\t\treturn !maps.length; \n\t\t},\n\n\t\tcategory: function () { \n\n\t\t\treturn category; \n\t\t},\n\n\t\tsetCategory: function (category) {\n\n\t\t\treturn byCategory(category);\n\t\t},\n\n\t\tall: function (){ \n\n\t\t\treturn maps; \n\t\t},\n\n    \tbyId: function (id) {\n\n\t        var map = byId(maps, id);\n\n\t        if (map) {\n\n\t        \treturn format(map);\n\t        }\n\n\t        return false;\n    \t},\n\n    \tfirst: function () { \n\n    \t\treturn sub(maps[0]); \n    \t},\n\n    \taddElement:function(room){\n\n    \t\treturn edit(types.game.items, room, function (games, room, index) {\n\n    \t\t\treturn isNaN(index) ? games.push(room) : (games[index] = room);\n    \t\t});\n        },\n\n        remove: function (room) {\n\n        \treturn edit(types.game.items, room, function (games, room, index) {\n\n        \t\tif (!isNaN(index) && !room.saved) {\n\n        \t\t\treturn games.splice(index, 1)[0];\n        \t\t}\n        \t});\n        },\n\n        removePlayer: function (room, player) {\n\n        \treturn edit(types.game.items, room, function (games, room, index) {\n\n        \t\tif (!isNaN(index)) {\n\n        \t\t\t(room = games[index]).players.splice(room.players.findIndex(function (p) {\n\t        \t\t\t\t\n\t        \t\t\t\treturn position.id === player.id;\n\n\t        \t\t}), 1)[0];\n        \t\t}\n        \t});\n        },\n\n        updated: function () { \n\n        \tif (change) {\n\n        \t\tchange = false;\n        \t\treturn true; \n        \t}\n        },\n\n        random: function () {\n\n        \tbyCategory(categories[app.calculate.random(categories.length - 1) || \"two\"], function (maps) {\n\n        \t\tapp.map.set([app.calculate.random(maps.length - 1)]);\n        \t});\n        },\n\n        index: function () {\n\n        \treturn index;\n        },\n\n        info: function () { \n\n        \treturn app.calculate.numberOfBuildings(byIndex(index || 0));\n        },\n\n        clear: function () {\n\n        \tmaps = [], \n        \tcategory = undefined, \n        \tindex = undefined;\n        },\n        \n        screen: function () { \n\n        \treturn types[type].elements; \n        },\n\n        save: function (map, name) {\n\n        \tif ((error = validate.defined (app.user.email(), \"email\") || (error = validate.map(map)))) {\n\n        \t \tthrow error;\n        \t}\n\n            app.request.post(mapController.setCreator(app.user.id(), map), \"maps/save\", function (response) {\n            \t\n            \tchange = true;\n            });\n        }\n        //getbyid: function (id) { app.request.get(id, \"maps/select\", function (response) { app.mapEditor.set(response); }); },\n\t};\n}();"]}